<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenLearn - Self-Learning System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /*
         * --- Zen Design & Color Palette ---
         * Inspired by nature, simplicity, and tranquility.
         * We use a dark, desaturated slate for the base, a calming sage for primary actions,
         * and a warm amber for highlights, creating a focused yet gentle environment.
        */
        :root {
            --bg-dark-slate: #1A202C; /* Base background - like a dark stone */
            --bg-light-slate: #2D3748; /* Lighter elements, cards */
            --bg-hover-slate: #4A5568; /* Hover states */
            --text-primary: #E2E8F0;   /* Main text - soft white */
            --text-secondary: #A0AEC0; /* Subtitles, less important text */
            --brand-sage: #689F84;     /* Primary buttons, progress - calming green */
            --brand-sage-hover: #5A8A72;
            --highlight-amber: #F6AD55; /* Highlights, notifications - warm, natural light */
        }

        body {
            font-family: 'Kanit', sans-serif; /* Changed font to Kanit */
            background-color: var(--bg-dark-slate);
            color: var(--text-primary);
        }

        /* --- Component Styling --- */
        .form-input {
            background-color: var(--bg-light-slate);
            border: 1px solid var(--bg-hover-slate);
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--brand-sage);
            box-shadow: 0 0 0 2px rgba(104, 159, 132, 0.5);
        }
        .btn-brand {
            background-color: var(--brand-sage);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-brand:hover:not(:disabled) {
            background-color: var(--brand-sage-hover);
        }
        .btn-brand:disabled {
            background-color: var(--bg-hover-slate);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .course-card {
            background-color: var(--bg-light-slate);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        .course-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }
        .progress-bar-fill {
            background-color: var(--brand-sage);
        }
        .progress-bar-bg {
            background-color: var(--bg-hover-slate);
        }

        /* --- Page Transitions --- */
        .page {
            display: none; /* Initially hide all pages */
        }
        .page.active {
            display: block; /* Show active page */
        }

        /* --- Zen Learning Environment --- */
        .course-sidebar {
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover-slate) var(--bg-light-slate);
        }
        .course-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .course-sidebar::-webkit-scrollbar-track {
            background: var(--bg-light-slate);
        }
        .course-sidebar::-webkit-scrollbar-thumb {
            background-color: var(--bg-hover-slate);
            border-radius: 10px;
        }
        .lesson-item.completed-lesson {
            color: var(--text-secondary);
        }
        .lesson-item.active-lesson {
            background-color: var(--brand-sage);
            color: white;
        }
        .lesson-item.active-lesson .lesson-title {
            text-decoration: none;
        }
        .lesson-item .lesson-title {
             text-decoration: none;
        }
        .lesson-item.completed-lesson .lesson-title {
            text-decoration: line-through;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen">

        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="flex items-center justify-center min-h-screen bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1489549132488-d00b7d80e42a?q=80&w=2070&auto=format&fit=crop');">
                <div class="w-full max-w-sm p-8 space-y-6 bg-black bg-opacity-60 backdrop-blur-sm rounded-2xl shadow-2xl">
                    <div class="text-center">
                        <h1 class="text-4xl font-bold text-white">ZenLearn</h1>
                        <p class="mt-2 text-lg font-light text-gray-300">Self-Learning System</p>
                    </div>
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="sr-only">ชื่อผู้ใช้</label>
                            <input id="username" name="username" type="text" required class="form-input w-full p-3 rounded-lg" placeholder="ชื่อผู้ใช้ (Username)">
                        </div>
                        <div>
                            <label for="password" class="sr-only">รหัสผ่าน</label>
                            <input id="password" name="password" type="password" required class="form-input w-full p-3 rounded-lg" placeholder="รหัสผ่าน (Password)">
                        </div>
                        <p id="login-error" class="text-amber-400 text-center h-4 text-sm"></p>
                        <div>
                            <button type="submit" id="login-submit-btn" class="w-full btn-brand font-bold py-3 px-4 rounded-lg text-lg">
                                เข้าสู่ระบบ
                            </button>
                        </div>
                    </form>
                    <!-- Contact Channels Added -->
                    <div class="text-center text-gray-300 pt-4 border-t border-gray-700">
                        <p class="mb-3 font-light">ช่องทางติดต่อ</p>
                        <div class="flex justify-center space-x-6">
                            <a href="https://www.facebook.com/profile.php?id=100089853924528" target="_blank" class="hover:text-white transition-colors"><i class="fab fa-facebook-f text-2xl"></i><span class="block text-xs mt-1">เรียนเลขกับพี่ต้าห์</span></a>
                            <a href="https://www.tiktok.com/@mathptah" target="_blank" class="hover:text-white transition-colors"><i class="fab fa-tiktok text-2xl"></i><span class="block text-xs mt-1">mathptah</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <header class="p-4 flex justify-between items-center sticky top-0 z-50 bg-slate-900/50 backdrop-blur-lg border-b border-slate-700">
                <h1 class="text-2xl font-bold text-white">ZenLearn</h1>
                <div class="flex items-center">
                    <span id="user-display-name" class="mr-4 text-gray-300"></span>
                    <button id="logout-btn" class="bg-slate-700 hover:bg-slate-600 py-2 px-4 rounded-lg text-sm">ออกจากระบบ</button>
                </div>
            </header>
            <main class="p-4 md:p-8">
                <h2 class="text-3xl font-semibold mb-6 text-gray-200">คอร์สเรียนของฉัน</h2>
                <div id="course-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8">
                    <!-- Course cards will be injected here -->
                </div>
                <div id="no-courses" class="hidden text-center py-20">
                    <i class="fas fa-book-open text-6xl text-slate-600"></i>
                    <h3 class="text-2xl text-slate-400 mt-4">ยังไม่มีคอร์สเรียน</h3>
                    <p class="text-slate-500 mt-2">โปรดติดต่อผู้ดูแลระบบเพื่อทำการลงทะเบียน</p>
                </div>
            </main>
        </div>

        <!-- Course Detail Page (Learning Environment) -->
        <div id="course-page" class="page">
            <div class="flex h-screen">
                <!-- Sidebar: Course Navigation -->
                <aside class="w-80 bg-slate-800 flex-shrink-0 flex flex-col course-sidebar overflow-y-auto">
                    <div class="p-4 border-b border-slate-700 sticky top-0 bg-slate-800 z-10">
                        <button id="back-to-dashboard" class="text-sm text-slate-300 hover:text-white mb-3">
                            <i class="fas fa-arrow-left mr-2"></i> กลับไปหน้าหลัก
                        </button>
                        <h3 id="course-sidebar-title" class="text-lg font-bold text-white"></h3>
                    </div>
                    <nav id="course-lesson-list" class="flex-grow p-2 space-y-1">
                        <!-- Lesson items will be injected here -->
                    </nav>
                </aside>

                <!-- Main Content: Player, Docs, etc. -->
                <main class="flex-grow flex flex-col bg-slate-900">
                    <div id="content-display-area" class="flex-grow p-4 md:p-8 flex items-center justify-center">
                        <!-- Content (video, doc, quiz) will be injected here -->
                    </div>
                    <div class="p-4 bg-slate-800/50 border-t border-slate-700 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="btn-brand opacity-50 pointer-events-none py-2 px-5 rounded-lg"><i class="fas fa-chevron-left mr-2"></i> ก่อนหน้า</button>
                        <div id="lesson-completion-area"></div>
                        <button id="next-lesson-btn" class="btn-brand opacity-50 pointer-events-none py-2 px-5 rounded-lg">ถัดไป <i class="fas fa-chevron-right ml-2"></i></button>
                    </div>
                </main>
            </div>
        </div>

    </div>

    <script>
        // --- API Connection ---
        // IMPORTANT SECURITY NOTE: The current backend uses Google Apps Script and Google Sheets.
        // This is NOT a secure or scalable solution for a real-world LMS, especially for user authentication.
        // Passwords should NEVER be stored or checked in plaintext.
        // RECOMMENDATION: Migrate to a proper backend service like Firebase (Authentication, Firestore) or a dedicated server with a database.
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbyUWO-BGs76jDbLCZrnFaWwhFvULFU-ISZlou7JFWAGH-8Pu5i5_bvadis3SYhMQet5Pw/exec';

        const api = {
            login: async function(username, password) {
                const url = `${webAppUrl}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('เกิดข้อผิดพลาดในการเชื่อมต่อ');
                const result = await response.json();
                if (result.status === 'success') return result.data;
                throw new Error(result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
            },
            getCourseDetails: async function(courseId) {
                const url = `${webAppUrl}?action=getCourseDetails&courseId=${encodeURIComponent(courseId)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลคอร์สได้');
                const result = await response.json();
                if (result.status === 'success') return result.data;
                throw new Error(result.message || 'ไม่พบข้อมูลคอร์ส');
            }
        };

        // --- Application State & DOM Elements ---
        const appState = {
            currentUser: null,
            currentCourse: null,
            currentLessonIndex: 0,
            lessonProgress: {} // { courseId: [true, false, ...] }
        };

        const pages = {
            login: document.getElementById('login-page'),
            dashboard: document.getElementById('dashboard-page'),
            course: document.getElementById('course-page'),
        };

        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-submit-btn');

        // --- Page Navigation ---
        function showPage(pageId) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageId].classList.add('active');
        }

        // --- Dashboard Logic ---
        function renderDashboard(userData) {
            document.getElementById('user-display-name').textContent = `สวัสดี, ${userData.name}`;
            const courseGrid = document.getElementById('course-grid');
            const noCoursesMessage = document.getElementById('no-courses');
            courseGrid.innerHTML = '';

            if (!userData.courses || userData.courses.length === 0) {
                noCoursesMessage.classList.remove('hidden');
            } else {
                noCoursesMessage.classList.add('hidden');
                userData.courses.forEach(course => {
                    const card = document.createElement('div');
                    card.className = 'course-card rounded-lg shadow-lg cursor-pointer group';
                    card.dataset.courseId = course.id;

                    card.innerHTML = `
                        <div class="relative aspect-[16/10]">
                            <img src="${course.coverImg}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/A0AEC0?text=Image+Not+Found';" alt="${course.title}" class="w-full h-full object-cover rounded-t-lg">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 right-0 p-4">
                                <h3 class="font-bold text-lg text-white truncate">${course.title}</h3>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="progress-bar-bg w-full h-1.5 rounded-full">
                                <div class="progress-bar-fill h-1.5 rounded-full" style="width: ${course.progress || 0}%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 text-right">${course.progress || 0}% เรียนไปแล้ว</p>
                        </div>
                    `;
                    card.addEventListener('click', () => showCourseDetail(course.id));
                    courseGrid.appendChild(card);
                });
            }
            showPage('dashboard');
        }

        // --- Course Detail (Learning Environment) Logic ---
        async function showCourseDetail(courseId) {
            try {
                const courseData = await api.getCourseDetails(courseId);
                appState.currentCourse = flattenCourseContent(courseData);
                
                const savedProgress = sessionStorage.getItem(`progress_${courseId}`);
                if (savedProgress) {
                    appState.lessonProgress[courseId] = JSON.parse(savedProgress);
                } else {
                    appState.lessonProgress[courseId] = new Array(appState.currentCourse.lessons.length).fill(false);
                }

                document.getElementById('course-sidebar-title').textContent = appState.currentCourse.title;
                renderLessonList();
                appState.currentLessonIndex = 0;
                renderLessonContent(0);
                showPage('course');
            } catch (error) {
                console.error("Failed to load course details:", error);
                // Use a more user-friendly modal/notification instead of alert
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            }
        }

        function flattenCourseContent(courseData) {
            const lessons = [];
            let lessonCounter = 0;
            if (courseData.content.videos) {
                courseData.content.videos.forEach(v => lessons.push({ index: lessonCounter++, type: 'video', title: v.title, url: v.url }));
            }
            if (courseData.content.documents) {
                const getGdriveId = (url) => (url.match(/\/d\/([\w-]+)/) || [])[1] || '';
                courseData.content.documents.forEach(d => lessons.push({ index: lessonCounter++, type: 'document', title: d.title, previewUrl: `https://drive.google.com/file/d/${getGdriveId(d.url)}/preview`, downloadUrl: `https://drive.google.com/uc?export=download&id=${getGdriveId(d.url)}` }));
            }
            if (courseData.content.exercises) {
                courseData.content.exercises.forEach(e => lessons.push({ index: lessonCounter++, type: 'quiz', title: e.title, url: e.url }));
            }
             if (courseData.content.exam) {
                courseData.content.exam.forEach(ex => lessons.push({ index: lessonCounter++, type: 'quiz', title: ex.title, url: ex.url, isExam: true }));
            }
            courseData.lessons = lessons;
            return courseData;
        }

        function renderLessonList() {
            const lessonListEl = document.getElementById('course-lesson-list');
            lessonListEl.innerHTML = '';
            const courseId = appState.currentCourse.courseId;
            const progress = appState.lessonProgress[courseId] || [];

            appState.currentCourse.lessons.forEach((lesson, index) => {
                const li = document.createElement('li');
                const icon = lesson.type === 'video' ? 'fa-play-circle' : lesson.type === 'document' ? 'fa-file-alt' : 'fa-question-circle';
                li.className = `lesson-item p-3 rounded-lg cursor-pointer flex items-center transition-colors duration-200 hover:bg-slate-700`;
                li.classList.toggle('active-lesson', index === appState.currentLessonIndex);
                li.classList.toggle('completed-lesson', progress[index]);
                li.dataset.lessonIndex = index;
                li.innerHTML = `
                    <i class="fas ${progress[index] ? 'fa-check-circle text-green-400' : icon} w-8 text-center text-slate-400"></i>
                    <span class="flex-grow lesson-title">${lesson.title}</span>
                `;
                li.addEventListener('click', () => {
                    appState.currentLessonIndex = index;
                    renderLessonContent(index);
                    renderLessonList();
                });
                lessonListEl.appendChild(li);
            });
        }

        function renderLessonContent(index) {
            const lesson = appState.currentCourse.lessons[index];
            const contentArea = document.getElementById('content-display-area');
            let contentHtml = '';

            switch(lesson.type) {
                case 'video':
                    contentHtml = `<iframe class="w-full max-w-5xl aspect-video rounded-lg shadow-2xl bg-black" src="${lesson.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    break;
                case 'document':
                    contentHtml = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-800 rounded-lg p-8 text-center">
                        <i class="fas fa-file-pdf text-8xl text-slate-600 mb-6"></i>
                        <h2 class="text-2xl font-bold mb-4">${lesson.title}</h2>
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                            <a href="${lesson.previewUrl}" target="_blank" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-6 rounded-lg transition-colors">🔍 ดูตัวอย่าง</a>
                            <a href="${lesson.downloadUrl}" class="bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-6 rounded-lg transition-colors">⬇️ ดาวน์โหลด</a>
                        </div>
                    </div>`;
                    break;
                case 'quiz': // Updated logic for quizzes and exams
                    contentHtml = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-800 rounded-lg p-8 text-center">
                        <i class="fas fa-file-signature text-8xl text-slate-600 mb-6"></i>
                        <h2 class="text-2xl font-bold mb-2">${lesson.isExam ? 'ข้อสอบ' : 'แบบฝึกหัด'}</h2>
                        <p class="text-lg text-slate-300 mb-6">${lesson.title}</p>
                        <button onclick="window.open('${lesson.url}', '_blank')" class="bg-amber-500 hover:bg-amber-400 text-white font-bold py-3 px-8 rounded-lg transition-colors text-xl">
                            <i class="fas fa-external-link-alt mr-2"></i> เริ่มทำ
                        </button>
                    </div>`;
                    break;
                default:
                    contentHtml = `<p>ไม่รู้จักประเภทของบทเรียนนี้</p>`;
            }
            contentArea.innerHTML = contentHtml;
            updateNavigationButtons();
            renderCompletionButton();
        }
        
        function markLessonComplete() {
            const courseId = appState.currentCourse.courseId;
            const index = appState.currentLessonIndex;
            appState.lessonProgress[courseId][index] = true;
            sessionStorage.setItem(`progress_${courseId}`, JSON.stringify(appState.lessonProgress[courseId]));
            renderLessonList();
            renderCompletionButton();
            updateDashboardProgress();
        }

        function renderCompletionButton() {
            const completionArea = document.getElementById('lesson-completion-area');
            const courseId = appState.currentCourse.courseId;
            const isCompleted = appState.lessonProgress[courseId][appState.currentLessonIndex];
            
            if (isCompleted) {
                completionArea.innerHTML = `<div class="text-green-400 font-bold flex items-center"><i class="fas fa-check-circle mr-2"></i> เรียนแล้ว</div>`;
            } else {
                const button = document.createElement('button');
                button.className = 'bg-amber-500 hover:bg-amber-400 text-white font-bold py-2 px-5 rounded-lg transition-colors';
                button.innerHTML = '<i class="fas fa-check mr-2"></i>ทำเครื่องหมายว่าเรียนแล้ว';
                button.onclick = markLessonComplete;
                completionArea.innerHTML = '';
                completionArea.appendChild(button);
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-lesson-btn');
            const nextBtn = document.getElementById('next-lesson-btn');
            const totalLessons = appState.currentCourse.lessons.length;

            prevBtn.classList.toggle('opacity-50', appState.currentLessonIndex <= 0);
            prevBtn.classList.toggle('pointer-events-none', appState.currentLessonIndex <= 0);

            nextBtn.classList.toggle('opacity-50', appState.currentLessonIndex >= totalLessons - 1);
            nextBtn.classList.toggle('pointer-events-none', appState.currentLessonIndex >= totalLessons - 1);
        }

        function navigateLesson(direction) {
            const newIndex = appState.currentLessonIndex + direction;
            if (newIndex >= 0 && newIndex < appState.currentCourse.lessons.length) {
                appState.currentLessonIndex = newIndex;
                renderLessonContent(newIndex);
                renderLessonList();
            }
        }

        // --- Event Listeners & Initialization ---
        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>&nbsp;&nbsp;กำลังตรวจสอบ...`;
            
            try {
                const userData = await api.login(loginForm.username.value, loginForm.password.value);
                appState.currentUser = userData;
                sessionStorage.setItem('user', JSON.stringify(userData));
                renderDashboard(userData);
            } catch (error) {
                loginError.textContent = error.message;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'เข้าสู่ระบบ';
            }
        }

        function handleLogout() {
            sessionStorage.clear();
            appState.currentUser = null;
            appState.currentCourse = null;
            appState.lessonProgress = {};
            loginForm.reset();
            loginError.textContent = '';
            showPage('login');
        }

        function init() {
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                if (appState.currentUser) {
                    renderDashboard(appState.currentUser);
                } else {
                    handleLogout();
                }
            });
            document.getElementById('prev-lesson-btn').addEventListener('click', () => navigateLesson(-1));
            document.getElementById('next-lesson-btn').addEventListener('click', () => navigateLesson(1));

            const storedUser = sessionStorage.getItem('user');
            if (storedUser) {
                appState.currentUser = JSON.parse(storedUser);
                renderDashboard(appState.currentUser);
            } else {
                showPage('login');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
