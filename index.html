<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≤‡∏´‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font changed back to Anuphan -->
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark-slate: #1A202C;
            --bg-light-slate: #2D3748;
            --bg-hover-slate: #4A5568;
            --text-primary: #E2E8F0;
            --text-secondary: #A0AEC0;
            --brand-sage: #689F84;
            --brand-sage-hover: #5A8A72;
            --highlight-amber: #F6AD55;
            --danger-red: #E53E3E;
        }

        body {
            /* Font changed back to Anuphan */
            font-family: 'Anuphan', sans-serif;
            background-color: var(--bg-dark-slate);
            color: var(--text-primary);
        }

        .form-input {
            background-color: var(--bg-light-slate);
            border: 1px solid var(--bg-hover-slate);
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--brand-sage);
            box-shadow: 0 0 0 2px rgba(104, 159, 132, 0.5);
        }
        .btn-brand {
            background-color: var(--brand-sage);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-brand:hover:not(:disabled) {
            background-color: var(--brand-sage-hover);
        }
        .btn-brand:disabled {
            background-color: var(--bg-hover-slate);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .course-card {
            background-color: var(--bg-light-slate);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .course-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }
        .progress-bar-fill {
            background-color: var(--brand-sage);
        }
        .progress-bar-bg {
            background-color: var(--bg-hover-slate);
        }
        .page { display: none; }
        .page.active { display: block; }

        /* Mobile-First Sidebar Styles */
        .course-sidebar {
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover-slate) var(--bg-light-slate);
        }
        .course-sidebar::-webkit-scrollbar { width: 6px; }
        .course-sidebar::-webkit-scrollbar-track { background: var(--bg-light-slate); }
        .course-sidebar::-webkit-scrollbar-thumb {
            background-color: var(--bg-hover-slate);
            border-radius: 10px;
        }
        .lesson-group-header {
            padding: 10px 8px 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--highlight-amber);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .lesson-item.completed-lesson { color: var(--text-secondary); }
        .lesson-item.active-lesson {
            background-color: var(--brand-sage);
            color: white;
        }
        .lesson-item .lesson-title { text-decoration: none; }
        .lesson-item.completed-lesson .lesson-title { text-decoration: line-through; }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen">

        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="flex items-center justify-center min-h-screen bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1489549132488-d00b7d80e42a?q=80&w=2070&auto=format&fit=crop');">
                <div class="w-full max-w-sm p-8 space-y-6 bg-black bg-opacity-60 backdrop-blur-sm rounded-2xl shadow-2xl">
                    <div class="text-center">
                        <h1 class="text-4xl font-bold text-white">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≤‡∏´‡πå</h1>
                        <p class="mt-2 text-lg font-light text-gray-300">KruP'Tah Self-Learning System</p>
                    </div>
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="sr-only">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input id="username" name="username" type="text" required class="form-input w-full p-3 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
                        </div>
                        <div>
                            <label for="password" class="sr-only">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input id="password" name="password" type="password" required class="form-input w-full p-3 rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
                        </div>
                        <p id="login-error" class="text-amber-400 text-center h-4 text-sm"></p>
                        <div>
                            <button type="submit" id="login-submit-btn" class="w-full btn-brand font-bold py-3 px-4 rounded-lg text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </form>
                    <div class="text-center text-gray-300 pt-4 border-t border-gray-700">
                        <p class="mb-3 font-light">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
                        <div class="flex justify-center space-x-6">
                            <a href="https://www.facebook.com/mathptah" target="_blank" class="hover:text-white transition-colors"><i class="fab fa-facebook-f text-2xl"></i><span class="block text-xs mt-1">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≤‡∏´‡πå</span></a>
                            <a href="https://www.tiktok.com/@mathptah?_t=ZS-8xozEP3Abqe&_r=1" target="_blank" class="hover:text-white transition-colors"><i class="fab fa-tiktok text-2xl"></i><span class="block text-xs mt-1">mathptah</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <header class="p-4 flex justify-between items-center sticky top-0 z-30 bg-slate-900/50 backdrop-blur-lg border-b border-slate-700">
                <h1 class="text-2xl font-bold text-white">ZenLearn</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <div id="dashboard-clock" class="text-lg font-semibold text-white"></div>
                        <div id="dashboard-date" class="text-xs text-slate-400"></div>
                    </div>
                    <div class="w-px h-10 bg-slate-700"></div>
                    <span id="user-display-name" class="text-gray-300 hidden sm:block"></span>
                    <button id="logout-btn" class="bg-slate-700 hover:bg-slate-600 py-2 px-4 rounded-lg text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="p-4 md:p-8">
                <h2 class="text-3xl font-semibold mb-6 text-gray-200">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <div id="course-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8"></div>
                <div id="no-courses" class="hidden text-center py-20">
                    <i class="fas fa-book-open text-6xl text-slate-600"></i>
                    <h3 class="text-2xl text-slate-400 mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <p class="text-slate-500 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                </div>
            </main>
        </div>

        <!-- Course Detail Page (Mobile-First) -->
        <div id="course-page" class="page">
            <!-- Mobile Sidebar Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
            
            <div class="relative min-h-screen lg:flex">
                <!-- Sidebar: Hidden on mobile, visible on desktop -->
                <aside id="course-sidebar" class="fixed inset-y-0 left-0 w-72 bg-slate-800 flex-shrink-0 flex flex-col course-sidebar overflow-y-auto z-40 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out">
                    <div class="p-4 border-b border-slate-700 sticky top-0 bg-slate-800 z-10">
                        <div class="flex justify-between items-center">
                             <h3 id="course-sidebar-title" class="text-lg font-bold text-white"></h3>
                             <button id="close-sidebar-btn" class="lg:hidden text-slate-400 hover:text-white text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <nav id="course-lesson-list" class="flex-grow p-2 space-y-1"></nav>
                    <div class="p-4 mt-auto border-t border-slate-700 sticky bottom-0 bg-slate-800">
                        <a href="https://forms.gle/E5Jzw7w4x6nqvKPz6" target="_blank" class="block w-full text-center bg-amber-500 hover:bg-amber-400 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-question-circle mr-2"></i> ‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≤‡∏°‡πÄ‡∏•‡∏¢
                        </a>
                    </div>
                    <div class="p-4 mt-auto border-t border-slate-700 sticky bottom-0 bg-slate-800">
                        <a href="https://kruptah.github.io" target="_blank" class="block w-full text-center bg-red-400 hover:bg-red-300 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-home mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                        </a>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <main class="flex-grow flex flex-col w-full lg:w-auto">
                    <!-- Header for Mobile and Desktop -->
                    <header class="p-4 flex justify-between items-center sticky top-0 z-20 bg-slate-900/50 backdrop-blur-lg border-b border-slate-700">
                        <div class="flex items-center">
                            <button id="open-sidebar-btn" class="lg:hidden text-white text-xl mr-4"><i class="fas fa-bars"></i></button>
                            <button id="back-to-dashboard" class="hidden lg:block text-sm text-slate-300 hover:text-white">
                                <i class="fas fa-arrow-left mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            </button>
                        </div>
                        <div class="text-center">
                            <div id="course-clock" class="text-lg font-semibold text-white"></div>
                            <div id="course-date" class="text-xs text-slate-400"></div>
                        </div>
                    </header>
                    <div id="content-display-area" class="flex-grow p-4 md:p-8 flex items-center justify-center"></div>
                    <div class="p-4 bg-slate-800/50 border-t border-slate-700 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="btn-brand opacity-50 pointer-events-none py-2 px-5 rounded-lg"><i class="fas fa-chevron-left mr-2"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                        <div id="lesson-completion-area"></div>
                        <button id="next-lesson-btn" class="btn-brand opacity-50 pointer-events-none py-2 px-5 rounded-lg">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right ml-2"></i></button>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbyUWO-BGs76jDbLCZrnFaWwhFvULFU-ISZlou7JFWAGH-8Pu5i5_bvadis3SYhMQet5Pw/exec';
        const api = {
            login: async (username, password) => {
                const url = `${webAppUrl}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                const result = await res.json();
                if (result.status === 'success') return result.data;
                throw new Error(result.message || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            },
            getCourseDetails: async (courseId) => {
                const url = `${webAppUrl}?action=getCourseDetails&courseId=${encodeURIComponent(courseId)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÑ‡∏î‡πâ');
                const result = await res.json();
                if (result.status === 'success') return result.data;
                throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™');
            }
        };

        const appState = {
            currentUser: null,
            currentCourse: null,
            currentLessonIndex: 0,
            lessonProgress: {},
            clockInterval: null,
        };

        const pages = {
            login: document.getElementById('login-page'),
            dashboard: document.getElementById('dashboard-page'),
            course: document.getElementById('course-page'),
        };
        
        // Mobile UI Elements
        const sidebar = document.getElementById('course-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');

        const showPage = (pageId) => {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageId].classList.add('active');
        };

        const renderDashboard = (userData) => {
            document.getElementById('user-display-name').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userData.name}`;
            const courseGrid = document.getElementById('course-grid');
            const noCoursesMessage = document.getElementById('no-courses');
            courseGrid.innerHTML = '';

            if (!userData.courses || userData.courses.length === 0) {
                noCoursesMessage.classList.remove('hidden');
            } else {
                noCoursesMessage.classList.add('hidden');
                userData.courses.forEach(course => {
                    const card = document.createElement('div');
                    card.className = 'course-card rounded-lg shadow-lg group';
                    let isClickable = true;

                    let countdownHtml = '';
                    if (course.enrollment && course.enrollment.startDate && course.enrollment.durationDays) {
                        const startDate = new Date(course.enrollment.startDate);
                        const endDate = new Date(new Date(startDate).setDate(startDate.getDate() + parseInt(course.enrollment.durationDays, 10)));
                        const now = new Date();
                        const timeLeft = endDate - now;
                        
                        if (timeLeft < 0) {
                            countdownHtml = `<div class="text-xs text-slate-500"><i class="fas fa-times-circle mr-1"></i> ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>`;
                            card.style.opacity = '0.7';
                            isClickable = false;
                        } else {
                            const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                            const colorClass = daysLeft <= 7 ? 'text-red-400' : 'text-slate-400';
                            countdownHtml = `<div class="text-xs ${colorClass}"><i class="fas fa-clock mr-1"></i> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</div>`;
                        }
                    }
                    
                    if(isClickable) {
                        card.classList.add('cursor-pointer');
                        card.addEventListener('click', () => showCourseDetail(course.id));
                    }

                    card.innerHTML = `
                        <div class="relative aspect-[16/10] flex-shrink-0">
                            <img src="${course.coverImg}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/A0AEC0?text=Image+Not+Found';" alt="${course.title}" class="w-full h-full object-cover rounded-t-lg">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 right-0 p-4">
                                <h3 class="font-bold text-lg text-white truncate">${course.title}</h3>
                            </div>
                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <div class="flex-grow">
                                <div class="progress-bar-bg w-full h-1.5 rounded-full">
                                    <div class="progress-bar-fill h-1.5 rounded-full" style="width: ${course.progress || 0}%"></div>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <p class="text-xs text-slate-400">${course.progress || 0}% ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</p>
                                    ${countdownHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    courseGrid.appendChild(card);
                });
            }
            showPage('dashboard');
        };

        const showCourseDetail = async (courseId) => {
            try {
                const courseData = await api.getCourseDetails(courseId);
                appState.currentCourse = groupAndFlattenCourseContent(courseData);
                const savedProgress = sessionStorage.getItem(`progress_${courseId}`);
                appState.lessonProgress[courseId] = savedProgress ? JSON.parse(savedProgress) : {};

                document.getElementById('course-sidebar-title').textContent = appState.currentCourse.title;
                renderLessonList();
                const firstLessonKey = Object.keys(appState.currentCourse.groupedLessons).find(key => appState.currentCourse.groupedLessons[key].length > 0);
                if (firstLessonKey) {
                    const firstLesson = appState.currentCourse.groupedLessons[firstLessonKey][0];
                    renderLessonContent(firstLesson);
                }
                showPage('course');
            } catch (error) {
                console.error("Failed to load course details:", error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        };

        const groupAndFlattenCourseContent = (courseData) => {
            const grouped = { videos: [], documents: [], quizzes: [], exams: [] };
            const flatList = [];
            let flatIndex = 0;

            const processItems = (items, type, groupKey) => {
                if (items) {
                    items.forEach(item => {
                        const lesson = { ...item, type, groupKey, flatIndex: flatIndex++ };
                        if (type === 'document') {
                            const id = (item.url.match(/\/d\/([\w-]+)/) || [])[1] || '';
                            lesson.previewUrl = `https://drive.google.com/file/d/${id}/preview`;
                            lesson.downloadUrl = `https://drive.google.com/uc?export=download&id=${id}`;
                        }
                        grouped[groupKey].push(lesson);
                        flatList.push(lesson);
                    });
                }
            };
            
            processItems(courseData.content.videos, 'video', 'videos');
            processItems(courseData.content.documents, 'document', 'documents');
            processItems(courseData.content.exercises, 'quiz', 'quizzes');
            processItems(courseData.content.exam, 'quiz', 'exams');

            courseData.groupedLessons = grouped;
            courseData.flatLessons = flatList;
            return courseData;
        };

        const renderLessonList = () => {
            const lessonListEl = document.getElementById('course-lesson-list');
            lessonListEl.innerHTML = '';
            const courseId = appState.currentCourse.courseId;
            const progress = appState.lessonProgress[courseId] || {};
            const groupHeaders = {
                videos: "‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠",
                documents: "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                quizzes: "‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î",
                exams: "‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö"
            };

            for (const groupKey in appState.currentCourse.groupedLessons) {
                const lessons = appState.currentCourse.groupedLessons[groupKey];
                if (lessons.length > 0) {
                    const header = document.createElement('h3');
                    header.className = 'lesson-group-header';
                    header.textContent = groupHeaders[groupKey];
                    lessonListEl.appendChild(header);

                    lessons.forEach(lesson => {
                        const li = document.createElement('li');
                        const isCompleted = !!progress[lesson.flatIndex];
                        const icon = lesson.type === 'video' ? 'fa-play-circle' : lesson.type === 'document' ? 'fa-file-alt' : 'fa-question-circle';
                        li.className = `lesson-item p-3 rounded-lg cursor-pointer flex items-center transition-colors duration-200 hover:bg-slate-700`;
                        li.classList.toggle('active-lesson', lesson.flatIndex === appState.currentLessonIndex);
                        li.classList.toggle('completed-lesson', isCompleted);
                        li.addEventListener('click', () => {
                            renderLessonContent(lesson);
                            renderLessonList();
                            toggleMobileMenu(false); // Close menu on selection
                        });
                        li.innerHTML = `
                            <i class="fas ${isCompleted ? 'fa-check-circle text-green-400' : icon} w-8 text-center text-slate-400"></i>
                            <span class="flex-grow lesson-title">${lesson.title}</span>
                        `;
                        lessonListEl.appendChild(li);
                    });
                }
            }
        };

        const renderLessonContent = (lesson) => {
            appState.currentLessonIndex = lesson.flatIndex;
            const contentArea = document.getElementById('content-display-area');
            let contentHtml = '';

            switch(lesson.type) {
                case 'video':
                    contentHtml = `<iframe class="w-full max-w-5xl aspect-video rounded-lg shadow-2xl bg-black" src="${lesson.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    break;
                case 'document':
                    contentHtml = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-800 rounded-lg p-8 text-center">
                        <i class="fas fa-file-pdf text-8xl text-slate-600 mb-6"></i>
                        <h2 class="text-2xl font-bold mb-4">${lesson.title}</h2>
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                            <a href="${lesson.previewUrl}" target="_blank" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-6 rounded-lg transition-colors">üîç ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</a>
                            <a href="${lesson.downloadUrl}" class="bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-6 rounded-lg transition-colors">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                        </div>
                    </div>`;
                    break;
                case 'quiz':
                    contentHtml = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-800 rounded-lg p-8 text-center">
                        <i class="fas fa-file-signature text-8xl text-slate-600 mb-6"></i>
                        <h2 class="text-2xl font-bold mb-2">${lesson.groupKey === 'exams' ? '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö' : '‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î'}</h2>
                        <p class="text-lg text-slate-300 mb-6">${lesson.title}</p>
                        <button onclick="window.open('${lesson.url}', '_blank')" class="bg-amber-500 hover:bg-amber-400 text-white font-bold py-3 px-8 rounded-lg transition-colors text-xl">
                            <i class="fas fa-external-link-alt mr-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥
                        </button>
                    </div>`;
                    break;
                default: contentHtml = `<p>‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>`;
            }
            contentArea.innerHTML = contentHtml;
            updateNavigationButtons();
            renderCompletionButton();
        };
        
        const markLessonComplete = () => {
            const courseId = appState.currentCourse.courseId;
            const index = appState.currentLessonIndex;
            if (!appState.lessonProgress[courseId]) appState.lessonProgress[courseId] = {};
            appState.lessonProgress[courseId][index] = true;
            sessionStorage.setItem(`progress_${courseId}`, JSON.stringify(appState.lessonProgress[courseId]));
            renderLessonList();
            renderCompletionButton();
        };

        const renderCompletionButton = () => {
            const completionArea = document.getElementById('lesson-completion-area');
            const courseId = appState.currentCourse.courseId;
            const isCompleted = appState.lessonProgress[courseId]?.[appState.currentLessonIndex];
            
            if (isCompleted) {
                completionArea.innerHTML = `<div class="text-green-400 font-bold flex items-center"><i class="fas fa-check-circle mr-2"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`;
            } else {
                const button = document.createElement('button');
                button.className = 'bg-amber-500 hover:bg-amber-400 text-white font-bold py-2 px-5 rounded-lg transition-colors';
                button.innerHTML = '<i class="fas fa-check mr-2"></i>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                button.onclick = markLessonComplete;
                completionArea.innerHTML = '';
                completionArea.appendChild(button);
            }
        };

        const updateNavigationButtons = () => {
            const prevBtn = document.getElementById('prev-lesson-btn');
            const nextBtn = document.getElementById('next-lesson-btn');
            const flatLessons = appState.currentCourse.flatLessons;
            const currentIndex = appState.currentLessonIndex;

            const canGoPrev = currentIndex > 0;
            prevBtn.classList.toggle('opacity-50', !canGoPrev);
            prevBtn.classList.toggle('pointer-events-none', !canGoPrev);

            const canGoNext = currentIndex < flatLessons.length - 1;
            nextBtn.classList.toggle('opacity-50', !canGoNext);
            nextBtn.classList.toggle('pointer-events-none', !canGoNext);
        };

        const navigateLesson = (direction) => {
            const newIndex = appState.currentLessonIndex + direction;
            const flatLessons = appState.currentCourse.flatLessons;
            if (newIndex >= 0 && newIndex < flatLessons.length) {
                const newLesson = flatLessons.find(l => l.flatIndex === newIndex);
                if (newLesson) {
                    renderLessonContent(newLesson);
                    renderLessonList();
                }
            }
        };

        const handleLogin = async (event) => {
            event.preventDefault();
            const loginBtn = document.getElementById('login-submit-btn');
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>&nbsp;&nbsp;‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...`;
            
            try {
                const userData = await api.login(document.getElementById('username').value, document.getElementById('password').value);
                appState.currentUser = userData;
                sessionStorage.setItem('user', JSON.stringify(userData));
                renderDashboard(userData);
            } catch (error) {
                loginError.textContent = error.message;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        };

        const handleLogout = () => {
            sessionStorage.clear();
            appState.currentUser = null;
            appState.currentCourse = null;
            appState.lessonProgress = {};
            document.getElementById('login-form').reset();
            document.getElementById('login-error').textContent = '';
            showPage('login');
        };

        const updateClock = () => {
            const now = new Date();
            const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateOpts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            const timeString = now.toLocaleTimeString('th-TH', timeOpts);
            const dateString = now.toLocaleDateString('th-TH', dateOpts);

            document.getElementById('dashboard-clock').textContent = timeString;
            document.getElementById('dashboard-date').textContent = dateString;
            document.getElementById('course-clock').textContent = timeString;
            document.getElementById('course-date').textContent = dateString;
        };
        
        const toggleMobileMenu = (show) => {
            if (show) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        };

        const init = () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                if (appState.currentUser) renderDashboard(appState.currentUser);
                else handleLogout();
            });
            document.getElementById('prev-lesson-btn').addEventListener('click', () => navigateLesson(-1));
            document.getElementById('next-lesson-btn').addEventListener('click', () => navigateLesson(1));
            
            // Mobile menu listeners
            openSidebarBtn.addEventListener('click', () => toggleMobileMenu(true));
            closeSidebarBtn.addEventListener('click', () => toggleMobileMenu(false));
            sidebarOverlay.addEventListener('click', () => toggleMobileMenu(false));

            const storedUser = sessionStorage.getItem('user');
            if (storedUser) {
                appState.currentUser = JSON.parse(storedUser);
                renderDashboard(appState.currentUser);
            } else {
                showPage('login');
            }
            
            if (appState.clockInterval) clearInterval(appState.clockInterval);
            updateClock();
            appState.clockInterval = setInterval(updateClock, 1000);
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
