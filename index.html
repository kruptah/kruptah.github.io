<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseFlix - แพลตฟอร์มเรียนออนไลน์ของคุณ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #141414;
            color: #ffffff;
        }
        .course-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .course-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .lesson-item.active {
            background-color: #2e2e2e;
            border-left: 3px solid #3b82f6;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .backdrop-blur-sm {
             backdrop-filter: blur(4px);
        }
        .bg-opacity-80 {
            background-color: rgba(20, 20, 20, 0.8);
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- ======================= Loading Overlay ======================= -->
    <div id="loading-overlay" class="hidden">
        <div class="text-white text-xl flex items-center">
            <i class="fas fa-spinner fa-spin mr-3"></i>
            กำลังโหลด...
        </div>
    </div>
    
    <!-- ======================= Login Page ======================= -->
    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="bg-[#1f1f1f] p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700">
            <h1 class="text-3xl font-bold text-center mb-2">CourseFlix</h1>
            <p class="text-center text-gray-400 mb-8">เข้าสู่ระบบเพื่อเรียนรู้</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-300 mb-2">อีเมล</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com" value="student@example.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-300 mb-2">รหัสผ่าน</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" value="1234">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">เข้าสู่ระบบ</button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden">อีเมลหรือรหัสผ่านไม่ถูกต้อง</p>
            </form>
        </div>
    </div>

    <!-- ======================= Main App (Hidden by default) ======================= -->
    <div id="app-page" class="hidden">
        
        <header class="bg-[#141414]/80 backdrop-blur-sm sticky top-0 z-50 py-4 px-4 md:px-8 border-b border-gray-800">
            <div class="flex justify-between items-center max-w-screen-2xl mx-auto">
                <h1 class="text-2xl font-bold text-blue-500 cursor-pointer" id="logo-button">CourseFlix</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-greeting" class="text-gray-300">สวัสดี, ผู้เรียน</span>
                    <i class="fa-solid fa-right-from-bracket text-gray-400 hover:text-white cursor-pointer" id="logout-button" title="ออกจากระบบ"></i>
                </div>
            </div>
        </header>

        <main class="max-w-screen-2xl mx-auto p-4 md:p-8">
            <div id="dashboard-view">
                <h2 class="text-3xl font-semibold mb-6" id="dashboard-welcome">คอร์สเรียนของคุณ</h2>
                <div id="course-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
            </div>
            <div id="course-view" class="hidden">
                <button id="back-to-dashboard" class="mb-6 text-blue-400 hover:text-blue-300"><i class="fas fa-arrow-left mr-2"></i> กลับไปหน้าหลัก</button>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="bg-black rounded-xl overflow-hidden shadow-2xl aspect-video mb-4">
                            <iframe id="content-player" src="" frameborder="0" allow="autoplay; fullscreen" allowfullscreen class="w-full h-full"></iframe>
                        </div>
                        <h2 id="course-title" class="text-4xl font-bold mb-2"></h2>
                        <p id="now-playing-text" class="text-gray-400 mb-4"></p>
                        <div class="my-4">
                           <div class="flex justify-between mb-1">
                               <span class="text-base font-medium text-blue-400">ความคืบหน้า</span>
                               <span id="progress-text" class="text-sm font-medium text-blue-400">0%</span>
                           </div>
                           <div class="w-full bg-gray-700 rounded-full h-2.5">
                               <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                           </div>
                        </div>
                        <div id="expiry-info" class="mt-4 p-4 bg-gray-800 rounded-lg text-center">
                            <i class="fa-solid fa-clock text-yellow-400 mr-2"></i>
                            <span id="expiry-text"></span>
                        </div>
                    </div>
                    <div class="bg-[#1f1f1f] p-4 rounded-xl shadow-lg border border-gray-800 self-start">
                        <h3 class="text-xl font-semibold mb-4">เนื้อหาในคอร์ส</h3>
                        <div id="lesson-list" class="space-y-2 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ================== CONFIGURATION ==================
    // !! สำคัญ: นำ URL ของเว็บแอปที่ได้จากการ Deploy Google Apps Script มาวางที่นี่ !!
    const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; 
    // ===================================================

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app-page');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const dashboardView = document.getElementById('dashboard-view');
    const courseView = document.getElementById('course-view');
    const courseList = document.getElementById('course-list');
    const userGreeting = document.getElementById('user-greeting');
    const dashboardWelcome = document.getElementById('dashboard-welcome');
    const backToDashboardBtn = document.getElementById('back-to-dashboard');
    const courseTitle = document.getElementById('course-title');
    const contentPlayer = document.getElementById('content-player');
    const lessonListContainer = document.getElementById('lesson-list');
    const nowPlayingText = document.getElementById('now-playing-text');
    const logoButton = document.getElementById('logo-button');
    const logoutButton = document.getElementById('logout-button');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const expiryInfo = document.getElementById('expiry-info');
    const expiryText = document.getElementById('expiry-text');

    // --- App State ---
    let currentUser = null;
    let userCourses = [];
    let currentCourse = null;

    // --- Functions ---
    function showLoading(isLoading) {
        loadingOverlay.classList.toggle('hidden', !isLoading);
    }

    function showPage(page) {
        loginPage.classList.add('hidden');
        appPage.classList.add('hidden');
        dashboardView.classList.add('hidden');
        courseView.classList.add('hidden');

        if (page === 'login') loginPage.classList.remove('hidden');
        else if (page === 'app') {
            appPage.classList.remove('hidden');
            dashboardView.classList.remove('hidden');
        } else if (page === 'course') {
            appPage.classList.remove('hidden');
            courseView.classList.remove('hidden');
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        loginError.classList.add('hidden');
        
        if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
            loginError.textContent = 'กรุณาตั้งค่า SCRIPT_URL ในไฟล์ HTML ก่อน';
            loginError.classList.remove('hidden');
            return;
        }

        showLoading(true);
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch(`${SCRIPT_URL}?action=login&email=${email}&password=${password}`);
            const data = await response.json();

            if (data.success) {
                currentUser = data.user;
                // Add a progress tracker to each course (client-side only)
                userCourses = data.courses.map(course => ({
                    ...course,
                    progress: { completed_lessons: [] } 
                }));
                loginError.classList.add('hidden');
                renderDashboard();
                showPage('app');
            } else {
                loginError.textContent = data.message || 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                loginError.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Login Error:', error);
            loginError.textContent = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
            loginError.classList.remove('hidden');
        } finally {
            showLoading(false);
        }
    }

    function handleLogout() {
        currentUser = null;
        userCourses = [];
        currentCourse = null;
        document.getElementById('email').value = "student@example.com";
        document.getElementById('password').value = "1234";
        showPage('login');
    }

    function renderDashboard() {
        if (!currentUser) return;

        userGreeting.textContent = `สวัสดี, ${currentUser.name}`;
        dashboardWelcome.textContent = `คอร์สเรียนของคุณ, ${currentUser.name}`;
        courseList.innerHTML = '';

        userCourses.forEach(course => {
            const daysRemaining = calculateDaysRemaining(course.expiry_date);
            const progress = calculateProgress(course);

            const card = document.createElement('div');
            card.className = 'course-card bg-[#1f1f1f] rounded-lg overflow-hidden shadow-lg cursor-pointer border border-gray-800';
            card.dataset.courseId = course.courseId;
            card.innerHTML = `
                <img src="${course.thumbnail}" alt="${course.title}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1f1f1f/FFFFFF?text=Image+Error';">
                <div class="p-4">
                    <h3 class="font-semibold text-lg truncate">${course.title}</h3>
                    <div class="w-full bg-gray-600 rounded-full h-1.5 mt-2">
                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">เหลือเวลา ${daysRemaining} วัน</p>
                </div>
            `;
            courseList.appendChild(card);
        });
    }

    function renderCourseView(courseId) {
        currentCourse = userCourses.find(c => c.courseId.toString() === courseId.toString());
        if (!currentCourse) return;
        
        courseTitle.textContent = currentCourse.title;
        renderLessonList();
        updateProgressUI();
        updateExpiryUI();
        
        const firstUncompleted = currentCourse.lessons.findIndex((lesson, index) => !currentCourse.progress.completed_lessons.includes(index));
        loadContent(firstUncompleted !== -1 ? firstUncompleted : 0);

        showPage('course');
    }
    
    function renderLessonList() {
        lessonListContainer.innerHTML = '';
        currentCourse.lessons.forEach((lesson, index) => {
            const isCompleted = currentCourse.progress.completed_lessons.includes(index);
            const icon = getLessonIcon(lesson.type, isCompleted);

            const lessonEl = document.createElement('div');
            lessonEl.className = 'lesson-item flex items-center p-3 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors duration-200';
            lessonEl.dataset.lessonIndex = index;
            lessonEl.innerHTML = `
                <div class="w-8 text-center mr-3">${icon}</div>
                <span class="flex-1 truncate">${lesson.title}</span>
                ${isCompleted ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
            `;
            lessonListContainer.appendChild(lessonEl);
        });
    }
    
    function getLessonIcon(type, isCompleted) {
        if (isCompleted) return `<i class="fa-solid fa-play-circle text-blue-500"></i>`;
        switch(type) {
            case 'video': return '<i class="far fa-play-circle text-gray-400"></i>';
            case 'quiz': return '<i class="fas fa-pencil-alt text-gray-400"></i>';
            case 'document': return '<i class="far fa-file-alt text-gray-400"></i>';
            case 'exam': return '<i class="fas fa-graduation-cap text-yellow-500"></i>';
            default: return '<i class="far fa-circle text-gray-400"></i>';
        }
    }

    function loadContent(lessonIndex) {
        const lesson = currentCourse.lessons[lessonIndex];
        if (!lesson) return;
        
        let embedUrl = '';
        switch(lesson.type) {
            case 'video':
            case 'document':
                embedUrl = `https://drive.google.com/file/d/${lesson.link}/preview`;
                break;
            case 'quiz':
            case 'exam':
                embedUrl = `https://docs.google.com/forms/d/e/${lesson.link}/viewform?embedded=true`;
                break;
        }
        contentPlayer.src = embedUrl;
        nowPlayingText.textContent = `กำลังเรียน: ${lesson.title}`;

        if (!currentCourse.progress.completed_lessons.includes(lessonIndex)) {
            currentCourse.progress.completed_lessons.push(lessonIndex);
        }

        document.querySelectorAll('.lesson-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.lesson-item[data-lesson-index='${lessonIndex}']`).classList.add('active');
        
        renderLessonList();
        updateProgressUI();
    }
    
    function updateProgressUI() {
        const progress = calculateProgress(currentCourse);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
    }

    function calculateProgress(course) {
        if (!course || !course.lessons || course.lessons.length === 0) return 0;
        const completedCount = course.progress.completed_lessons.length;
        const totalLessons = course.lessons.length;
        return totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
    }
    
    function updateExpiryUI() {
        const daysRemaining = calculateDaysRemaining(currentCourse.expiry_date);
        expiryText.textContent = `คอร์สนี้จะหมดอายุใน ${daysRemaining} วัน`;
        if(daysRemaining < 30) {
            expiryInfo.classList.remove('bg-gray-800');
            expiryInfo.classList.add('bg-red-900', 'border', 'border-red-700');
        } else {
            expiryInfo.classList.add('bg-gray-800');
            expiryInfo.classList.remove('bg-red-900', 'border', 'border-red-700');
        }
    }

    function calculateDaysRemaining(expiryDate) {
        try {
            const today = new Date();
            today.setHours(0,0,0,0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0,0,0,0);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        } catch(e) {
            return 0;
        }
    }

    // --- Event Listeners ---
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);
    backToDashboardBtn.addEventListener('click', () => {
        renderDashboard();
        showPage('app');
    });
    logoButton.addEventListener('click', () => {
        if(currentUser) {
            renderDashboard();
            showPage('app');
        }
    });
    courseList.addEventListener('click', (e) => {
        const card = e.target.closest('.course-card');
        if (card) renderCourseView(card.dataset.courseId);
    });
    lessonListContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.lesson-item');
        if (item) loadContent(parseInt(item.dataset.lessonIndex));
    });

    // Initial state
    showPage('login');
});
</script>

</body>
</html>
